!function(e){"use strict";e.widget("cp.UseyourDriveDashboard",{options:{$container_totals:e("#useyourdrive-totals"),$container_events_chart:e("#useyourdrive-events-chart"),$container_top_downloads:e("#top-downloads"),$container_top_users:e("#top-users"),$container_full_log:e("#full-log")},_create:function(){this._initiate()},_destroy:function(){return this._super()},_setOption:function(e,t){this._super(e,t)},_initiate:function(){var t=this;e("body").addClass("useyourdrive"),this._initChartDatePicker(),this.options.$container_totals.one("inview",function(e,a){t.loadTotalsData(t.options.$container_totals,null,null)}),this.options.$container_events_chart.one("inview",function(e,a){t.loadChartData()}),this.options.$container_top_downloads.one("inview",function(e,a){t.loadTopDownloads()}),this.options.$container_top_users.one("inview",function(e,a){t.loadTopUsers()}),this.options.$container_full_log.one("inview",function(e,a){t.loadFullLog()}),this._initEvents()},_initEvents:function(){var t=this;e(t.element).on("click","a.open-entry-details",function(a){var n=e(this).data("entry-id");t.viewEntryDetails(n)}),e("body").on("click","#useyourdrive-modal-action a.open-entry-details",function(a){var n=e(this).data("entry-id");t.viewEntryDetails(n)}),e(t.element).on("click","a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e("body").on("click","#useyourdrive-modal-action a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)})},_initChartDatePicker:function(){var e=this,t=e.element.find("#chart_datepicker_from"),a=e.element.find("#chart_datepicker_to");e.chart_datepicker_from=t.datepicker({altField:"#chart_datepicker_from",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0}).on("change",function(){e.chart_datepicker_to.datepicker("option","minDate",moment(t.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData()},1e3)}),t.datepicker("setDate",moment().subtract(1,"months").toDate()),e.chart_datepicker_to=a.datepicker({altField:"#chart_datepicker_to",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0,maxDate:"+0d"}).on("change",function(){e.chart_datepicker_from.datepicker("option","maxDate",moment(a.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData()},1e3)}),a.datepicker("setDate",moment().toDate())},loadChartData:function(){var t=this;t.options.$container_events_chart.prev().fadeIn(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"useyourdrive-event-stats",type:"activities",start:moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),end:moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e){t._setChart(e)},complete:function(e){t.options.$container_events_chart.prev().fadeOut()},dataType:"json"})},_setChart:function(e){new Chart(this.options.$container_events_chart,{type:"line",options:{responsive:!0,maintainAspectRatio:!1,legend:{position:"bottom"},tooltips:{mode:"x"},scales:{xAxes:[{type:"time",time:{parser:"DD-MM-YYYY",unit:"day",tooltipFormat:"LL"},scaleLabel:{display:!1},ticks:{beginAtZero:!1}}],yAxes:[{scaleLabel:{display:!1},ticks:{beginAtZero:!0}}]}},data:e})},loadTotalsData:function(t,a,n){var i=this;t.find(".useyourdrive-counter span").css({"background-color":"",color:""}),e.ajax({method:"POST",url:i.options.ajax_url,data:{action:"useyourdrive-event-stats",type:"totals",detail:a,id:n,_ajax_nonce:i.options.admin_nonce},success:function(e){i._setTotalsData(t,e)},complete:function(e){t.find(".loading").fadeOut()},dataType:"json"})},_setTotalsData:function(t,a){e.each(t.find(".useyourdrive-counter"),function(){var t=e(this).data("type");if(void 0===a[t])return e(this).find("span").append("0"),!0;var n=parseInt(a[t].total);e(this).find("span").css({"background-color":a[t].colors.normal,color:"white"}).append(n)})},loadTopDownloads:function(){var e=this;e.options.$container_top_downloads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'">'+a.entry_name+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:e.options.ajax_url+"?action=useyourdrive-event-stats&type=topdownloads&_ajax_nonce="+e.options.admin_nonce})},loadTopUsers:function(){this.options.$container_top_users.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:this.options.ajax_url+"?action=useyourdrive-event-stats&type=topusers&_ajax_nonce="+this.options.admin_nonce})},loadFullLog:function(){this.options.$container_full_log.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:500,scroller:!0,scrollCollapse:!0,pageLength:50,searchDelay:600,buttons:[{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"excel",text:'<i class="fas fa-file-excel fa-lg"></i>',className:"simple-button blue",title:""},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='fas "+e+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i> '+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:this.options.ajax_url+"?action=useyourdrive-event-stats&type=full-log&_ajax_nonce="+this.options.admin_nonce})},loadDetailedLog:function(e,t,a){e.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:300,scroller:!0,pageLength:50,searchDelay:600,responsive:!0,buttons:[{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"excel",text:'<i class="fas fa-file-excel fa-lg"></i>',className:"simple-button blue",title:""},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='fas "+e+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i>'+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:this.options.ajax_url+"?action=useyourdrive-event-stats&type=full-log&detail="+t+"&id="+a+"&_ajax_nonce="+this.options.admin_nonce})},viewEntryDetails:function(e){this.openModal("entry",e)},viewUserDetails:function(e){this.openModal("user",e)},openModal:function(t,a){var n=this;e("#useyourdrive-modal-action").remove();var i="";i+='<button class="simple-button blue useyourdrive-modal-cancel-btn" data-action="cancel" type="button" onclick="modal_action.close();" title="'+n.options.str_close_title+'" >'+n.options.str_close_title+"</button>";var s=e('<a tabindex="0" class="close-button" title="'+n.options.str_close_title+'" onclick="modal_action.close();"><i class="fas fa-times fa-lg" aria-hidden="true"></i></a></div>'),o=e('<div class="useyourdrive-modal-body" tabindex="0" style="display:none"></div>'),r=e('<div class="useyourdrive-modal-footer" style="display:none"><div class="useyourdrive-modal-buttons">'+i+"</div></div>"),l=e('<div id="useyourdrive-modal-action" class="UseyourDrive useyourdrive-modal useyourdrive-modal80 '+n.options.content_skin+'"><div class="modal-dialog"><div class="modal-content"><div class="loading"><div class="loader-beat"></div></div></div></div></div>');e("body").append(l);var d=e(".event-details-template").clone().appendTo(o).show();switch(e("#useyourdrive-modal-action .modal-content").append(s,o,r),t){case"user":var c=e(".modal-content  .event-details-user-template").show();break;case"entry":c=e(".modal-content  .event-details-entry-template").show()}var u=e(".modal-content .event-details-totals-template");u.find("span").html('<div class="loading"><div class="loader-beat"></div></div>'),n.loadTotalsData(u,t,a),e.ajax({type:"POST",url:n.options.ajax_url,data:{action:"useyourdrive-event-stats",type:"get-detail",detail:t,id:a,_ajax_nonce:n.options.admin_nonce},success:function(a){switch(t){case"user":d.find(".event-details-name").text(a.user.user_name),c.find(".event-details-email").text(a.user.user_email),c.find(".event-details-roles").text(a.user.user_roles),c.find(".event-details-entry-img").css("background-image","url("+a.user.avatar+")"),c.find(".event-visit-profile").attr("href",a.user.user_link);break;case"entry":d.find(".event-details-name").text(a.entry.entry_name),c.find(".event-details-description").text(a.entry.entry_description),c.find(".event-details-entry-img").css("background-image","url("+a.entry.entry_thumbnails+")"),!1===a.entry.entry_link?c.find(".event-download-entry").fadeOut():c.find(".event-download-entry").attr("href",a.entry.entry_link+"&_ajax_nonce="+n.options.admin_nonce)}e(".useyourdrive-modal-body").fadeIn(),e(".useyourdrive-modal-footer").fadeIn(),e(".modal-content .loading:first").fadeOut()},complete:function(){c.find(".loading").fadeOut()},dataType:"json"}),n.loadDetailedLog(e("#useyourdrive-modal-action .modal-content table"),t,a);var p=new RModal(document.getElementById("useyourdrive-modal-action"),{dialogOpenClass:"animated slideInDown",dialogCloseClass:"animated slideOutUp",escapeClose:!0});document.addEventListener("keydown",function(e){p.keydown(e)},!1),p.open(),window.modal_action=p}})}(jQuery),jQuery(".UseyourDriveDashboard").UseyourDriveDashboard(UseyourDrive_Dashboard_vars);